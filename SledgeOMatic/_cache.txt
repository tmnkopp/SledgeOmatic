 
DECLARE @PK_ReportingCycle  INT= 161--PK_ReportingCycle SELECT MAX(PK_ReportingCycle) FROM fsma_ReportingCycles 
,@Quarter  VARCHAR(2) = 'Q'
,@Year     VARCHAR(4) = '2024'
,@PK_Form  VARCHAR(20) = '2024-Q3-MFA'
,@FormName VARCHAR(10) = 'MFA' 
,@PK_QGroup INT = 5100 -- SELECT MAX(PK_QuestionGroup) FROM fsma_QuestionGroups  
,@PK_FormPage INT = 4600 -- SELECT TOP 5 PK_FormPage FROM fsma_FormPages  ORDER BY PK_FormPage DESC
,@PKQ INT 
,@Form_Description VARCHAR(99) = 'MFA Encryption/Compliance'
,@idMax AS INT = 0
,@FormType AS INT = 32
,@PK_DataCall AS INT = 30 
 
--//updating configuration tables for reporting section
IF NOT EXISTS (SELECT * FROM fsma_ReportingCycles WHERE PK_ReportingCycle = @PK_ReportingCycle)
BEGIN
	-- To run again it needs to delete manually reporting cycle first 
	--***  DELETING DATA CALL ***** 
	-- Reset answers 
	DELETE ans  from fsma_Answers ans
	INNER JOIN fsma_OrgSubmissions org ON org.PK_OrgSubmission=ans.FK_OrgSubmission
	WHERE org.PK_Form=@PK_Form

	-- Reset narratives 
	DELETE narr FROM fsma_NarrAnswers narr
	INNER JOIN fsma_OrgSubmissions org ON org.PK_OrgSubmission=narr.PK_OrgSubmission
	AND org.PK_Form=@PK_Form

	--Reporting cycle
	DELETE fsma_ReportingCycles WHERE PK_ReportingCycle = @PK_ReportingCycle

	--Reporting cycle_components
	DELETE fsma_ReportingCycle_Components WHERE FK_ReportingCycle=@PK_ReportingCycle
	SET @idMax = (SELECT MAX(PK_ReportingCycle_Component) FROM fsma_ReportingCycle_Components)
	DBCC CHECKIDENT('fsma_ReportingCycle_Components', RESEED, @idMax)

	DELETE fsma_FormMaster WHERE PK_Form=@PK_Form  
	-- Reset orgsubmission pk's
	DELETE fsma_Orgsubmissions WHERE PK_Form = @PK_Form
	SET @idMax=(SELECT MAX(PK_OrgSubmission) FROM fsma_Orgsubmissions)
	DBCC CHECKIDENT('fsma_Orgsubmissions', RESEED, @idMax)
 
	--***  CREATING NEW DATA CALL ***** 
	SET IDENTITY_INSERT [dbo].[fsma_ReportingCycles] ON
	
	INSERT INTO fsma_ReportingCycles (PK_ReportingCycle,IntervalCode, [Period], [Year], [Description], DateModified, IsActive, [Status], ScheduledActivation,  ScheduledClosed, PK_DataCall) VALUES	
		(@PK_ReportingCycle,'Q', @Quarter, @Year, @Form_Description + ' ' + @year, GETDATE(), 1, 'A', '2024-09-01', '2024-10-01', @PK_DataCall) 
	
	SET IDENTITY_INSERT [dbo].[fsma_ReportingCycles] OFF
	 
	INSERT INTO fsma_FormMaster (PK_Form, Report_Year, Form_Description,  TypeCode, IntervalCode, [Period], FK_ReportingCycle, FK_FormType) VALUES
	(@PK_Form, @Year, @Year + @Form_Description, 'MAJ', 'Q', @Year, @PK_ReportingCycle, @FormType)
  
	INSERT INTO fsma_ReportingCycle_Components (FK_ReportingCycle, FK_Component, Status_Code)
	SELECT @PK_ReportingCycle,  c.PK_Component, 'NS' FROM [Component List] c WHERE c.isActive = 1 AND FK_PK_Component IS NULL  
 
	DECLARE @RptComps table (rownum INT IDENTITY (1, 1) PRIMARY KEY NOT NULL , PK_ReportingCycle_Component INT)
	DECLARE @RowCnt INT 
	DECLARE @MaxRows INT  
		
	INSERT INTO @RptComps (PK_ReportingCycle_Component) 
	SELECT PK_ReportingCycle_Component FROM fsma_ReportingCycle_Components rc WHERE rc.FK_ReportingCycle = @PK_ReportingCycle
	SET @RowCnt = 1
	SELECT @MaxRows=count(*) from @RptComps
	 
	WHILE @RowCnt <= @MaxRows
	BEGIN
		DECLARE @PK_ReportCycle_Component INT 
		SELECT @PK_ReportCycle_Component = PK_ReportingCycle_Component FROM @RptComps WHERE rownum = @RowCnt   
		EXEC AgencyAddFormInstance @PK_ReportCycle_Component, @PK_Form, NULL  
		SELECT @RowCnt = @RowCnt + 1  
	END  
END
 
UPDATE fsma_FormMaster
SET 
InternalForm='MFA/2024/2024_Q3_MFA_1.aspx'
,CrystalReportForm='Reports/CrystalReportsFiles/MFAReport2024_Wide.rpt'
,SprocFormValidation=NULL 
,Form_Description=@Form_Description
WHERE PK_Form=@PK_Form 

UPDATE fsma_ReportingCycles SET Description='MFA/Encryption Compliance 2024 Q3' WHERE PK_ReportingCycle=@PK_ReportingCycle
UPDATE fsma_FormMaster SET Form_Description='MFA/Encryption Compliance' WHERE PK_Form=@PK_Form

---- 
   
DELETE FROM fsma_FormPages WHERE FK_Form=@PK_Form OR FK_Form = '2024-Q3-MFA'
SET IDENTITY_INSERT [dbo].[fsma_FormPages] ON
INSERT INTO fsma_FormPages (PK_FormPage, FK_Form, [Text], ASPX, sortpos) VALUES
	(@PK_FormPage,@PK_Form, '1. MFA Inventory', 'MFA/2024/2024_Q3_MFA_1.aspx', 0) 

SET IDENTITY_INSERT [dbo].[fsma_FormPages] OFF
 
DELETE FROM fsma_QuestionGroups WHERE PK_Form=@PK_Form OR PK_FORM = '2024-Q3-MFA'
SET IDENTITY_INSERT [dbo].[fsma_QuestionGroups] ON

INSERT INTO fsma_QuestionGroups (PK_QuestionGroup,GroupName, [Text], PK_Form, FK_FormPage, sortpos) VALUES
	(@PK_QGroup,'S1','Section 1: MFA Inventory',@PK_Form, @PK_FormPage, 1) 

SET IDENTITY_INSERT [dbo].[fsma_QuestionGroups] OFF
 
DELETE FROM fsma_Questions WHERE  FK_QuestionGroup IN(@PK_QGroup) 
 
SET IDENTITY_INSERT [dbo].[fsma_Questions] ON  

INSERT INTO fsma_Questions (PK_Question, FormName, FK_QuestionGroup,sortpos,identifier_text, FK_Question_Picklist, FK_PickListType, FK_QuestionType, FK_InputType, FK_PickList, WarningQuestion,reportable, ExternalLinkType, PK_ExternalLink,QuestionText, help_text) VALUES 

	 (60300, @FormName,@PK_QGroup, 1, N' ',  NULL, NULL, 18, 0, NULL, 0, 0, NULL, NULL, N'
	 
<p>This form was developed to capture component-level data on MFA and Encryption. CFO Act Agencies that have not implemented MFA, Encryption of Data in Transit, and Encryption of Data at Rest on 90% or more of agency systems must submit Bureau/Component-Level data on non-conforming systems as part of the FISMA data submission process.
</p> ',  NULL)
	,(60301, @FormName,@PK_QGroup, 2, N'1', NULL, NULL, 97, 0, NULL, 0,NULL,NULL,NULL, N'MFA/Encryption Compliance  (MFA) Inventory', NULL)
 
 
SET IDENTITY_INSERT [dbo].[fsma_Questions] OFF





<%@ Page Title="" Language="vb" AutoEventWireup="false" MasterPageFile="~/Form.Master" 
    CodeBehind="2024_Q3_MFA_1.aspx.vb" Inherits="CyberScope._2024_Q3_MFA_1" %> 
<%@ Register Src="../../CustomControls/CBlabel.ascx" TagName="CBlabel" TagPrefix="uc" %>
<%@ Register Src="../../CustomControls/CBoptionalLinks.ascx" TagName="CBoptionalLinks" TagPrefix="uc" %>
<%@ Register Src="../../CustomControls/MFAEncryption.ascx" TagName="MFAEncryption" TagPrefix="uc" %>
<%@ Register Src="../../CustomControls/CBtext2.ascx" TagName="CBtext2" TagPrefix="uc" %>
<%@ Register Src="../../CustomControls/CBYesNo.ascx" TagName="CBYesNo" TagPrefix="uc" %>
<%@ Register Src="../../CustomControls/CBButtPanel2.ascx" TagName="CBButtPanel" TagPrefix="uc" %>

<asp:Content ID="Content1" ContentPlaceHolderID="ContentPlaceHolder1" runat="Server"> 
    <asp:Panel ID="Panel1" runat="server"> 
        <table class="table table-sm"> 
			<tr>
                <td colspan="6" class="SectionHead">
                    <uc:CBlabel ID="CBlabelGroup" runat="server" LabelType="Group" PK_key="5100" />
                </td>
            </tr> 
            <tr>
                <td class="LabelColumn" colspan="6" style="text-align: left;">
                    <asp:BulletedList ID="bl_Errors" runat="server" Visible="false" Width="100%" 
                        ForeColor="Red" BulletStyle="NotSet" CssClass="leftalign">
                    </asp:BulletedList> 
                </td>
            </tr>
			<tr>
                <td style="width: 4%;text-align: left;" class="LabelNoWrap valigntop">
                    <uc:CBlabel ID="CBlabel1" CSSClass="CustomControlLabelNoVertAlign" runat="server"
                        LabelType="QuestionNumber" PK_key="60300" />
                </td>
                <td style="width: 90%;text-align: left;" class="LabelColumn" colspan="4">
                    <uc:CBlabel ID="CBlabel2" CSSClass="CustomControlLabelNoVertAlign" runat="server"
                        LabelType="Question" PK_key="60300" />
                </td>
                <td style="width: 6%;text-align: left;" class="ControlColumn">
                    <uc:CBoptionalLinks ID="CBoptionalLinks1" runat="server" ShowAudit="True"
                        TableName="MFAEncryption" AuditRecs="20" PK_Key="60300"
                        ShowHelp="True" ShowNarrative="true" />
                </td>
            </tr> 
 
 
            <asp:HiddenField runat="server" ID="hidShowGrid" Value="N"  />
            <tr id="r-m-MFAEncryptionGrid" class="MFAEncryptionGridRow" > 
                <td class="ControlColumn" colspan="6">
                    <uc:MFAEncryption ID="MFAEncryptionGrid" runat="server" ShowDeleteAll="true"  SectionCaption="MFA Inventory" ShowNA="false" PK_QuestionGroup="5100" />
                </td>
            </tr> 
 
        </table>
    </asp:Panel>
</asp:Content>






'------------------------------------------------------------------------------
' <auto-generated>
'     This code was generated by a tool.
'
'     Changes to this file may cause incorrect behavior and will be lost if
'     the code is regenerated. 
' </auto-generated>
'------------------------------------------------------------------------------

Option Strict On
Option Explicit On


Partial Public Class _2024_Q3_MFA_1

    '''<summary>
    '''Panel1 control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents Panel1 As Global.System.Web.UI.WebControls.Panel

    '''<summary>
    '''CBlabelGroup control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents CBlabelGroup As Global.CyberScope.CustomControls_CBlabel

    '''<summary>
    '''bl_Errors control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents bl_Errors As Global.System.Web.UI.WebControls.BulletedList

    '''<summary>
    '''CBlabel1 control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents CBlabel1 As Global.CyberScope.CustomControls_CBlabel

    '''<summary>
    '''CBlabel2 control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents CBlabel2 As Global.CyberScope.CustomControls_CBlabel

    '''<summary>
    '''CBoptionalLinks1 control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents CBoptionalLinks1 As Global.CyberScope.CustomControls_CBoptionalLinks

    '''<summary>
    '''hidShowGrid control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents hidShowGrid As Global.System.Web.UI.WebControls.HiddenField

    '''<summary>
    '''MFAEncryptionGrid control.
    '''</summary>
    '''<remarks>
    '''Auto-generated field.
    '''To modify move field declaration from designer file to code-behind file.
    '''</remarks>
    Protected WithEvents MFAEncryptionGrid As Global.CyberScope.MFAEncryption
End Class





Imports System.Web.Services
Imports CyberBalance.CS.Core
Imports CyberBalance.VB.Core
Imports CyberBalance.VB.Web.UI
Imports Newtonsoft.Json

Public Class _2024_Q3_MFA_1
    Inherits FismaFormBasePage2

    Protected Sub Page_Init(sender As Object, e As EventArgs) Handles Me.Init
        bl_Errors.Items.Clear()
    End Sub
    Protected Sub Page_PreRender(sender As Object, e As EventArgs) Handles Me.PreRender
        bl_Errors.Visible = bl_Errors.Items.Count > 0
    End Sub
    Protected Overrides Function FormValid(Optional ByVal bApprovalSubmit As Boolean = False) As Boolean
        Return bl_Errors.Items.Count < 1
    End Function
    <WebMethod()>
    Public Shared Function RequestMFAEncryption(request As SprocRequest)
        Return GetDataTable("MFAEncryption_CRUD", request)
    End Function
    Public Shared Function GetDataTable(SprocName As String, request As SprocRequest)
        request = request.StripScript()
        Dim _CAUser As CAuser, _UrlParams As URLParms
        CBWebBase.Init(_CAUser, _UrlParams)
        request.SprocName = SprocName
        request.PARMS.Add("@UserId", _CAUser.UserPK.ToString())
        request.PARMS.Add("@PK_OrgSubmission", _CAUser.PK_OrgSubmission.ToString())
        Dim oDb = New DataBaseUtils2()
        oDb.Parms = request.SprocParms
        Dim dt = oDb.GetDataTable(request.SprocName)
        Return JsonConvert.SerializeObject(dt).StripScript()
    End Function
End Class





